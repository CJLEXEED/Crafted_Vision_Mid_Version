<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art Discussion - Crafted Vision</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="discussion.css">
</head>
<body>
    <nav class="navbar fixed-top">
        <div class="container-fluid">
            <button class="back-button" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <h1 class="navbar-brand mb-0">Art Discussion</h1>
        </div>
    </nav>

    <main class="container mt-5 pt-4">
        <div class="row">
            <!-- Art details section -->
            <div class="col-md-8" id="art-details">
                <div class="art-card">
                    <img id="art-image" src="" alt="Artwork Image" class="img-fluid rounded">
                    <div class="art-info mt-3">
                        <h2>Art Title: <span id="art-title" class="text-primary">Loading...</span></h2>
                        <p class="artist"><strong>Artist:</strong> <span id="art-artist">Loading...</span></p>
                        <p class="description"><strong>Description:</strong> <span id="art-description">Loading...</span></p>
                        <div class="overall-rating">
                            <h3>Overall Rating</h3>
                            <div id="average-rating" class="rating-stars"></div>
                            <span id="rating-count">(0 ratings)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discussion form -->
            <div class="col-md-4">
                <div class="discussion-form-container">
                    <form id="discussion-form" onsubmit="handleSubmit(event)" class="mb-4">
                        <h3><i class="fas fa-comment"></i> Share Your Thoughts</h3>
                        <div class="mb-3">
                            <textarea name="thoughts" id="thoughts" class="form-control" rows="4" 
                                placeholder="What do you think about this artwork?" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="rating" class="form-label">Rate this Artwork</label>
                            <div class="rating-input">
                                <i class="far fa-star" data-rating="1"></i>
                                <i class="far fa-star" data-rating="2"></i>
                                <i class="far fa-star" data-rating="3"></i>
                                <i class="far fa-star" data-rating="4"></i>
                                <i class="far fa-star" data-rating="5"></i>
                            </div>
                            <input type="hidden" id="rating" name="rating" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-paper-plane"></i> Submit
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Comments section -->
        <section id="comments-section" class="mt-4">
            <h3><i class="fas fa-comments"></i> Discussion</h3>
            <div id="comments-list" class="comments-container"></div>
        </section>
    </main>

    <!-- Toast notification -->
    <div id="toast" class="toast-notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function goBack() {
            window.history.back();
        }

        const urlParams = new URLSearchParams(window.location.search);
        const title = decodeURIComponent(urlParams.get('title') || 'Sample Art Title');
        const artist = decodeURIComponent(urlParams.get('artist') || 'Sample Artist');
        const description = decodeURIComponent(urlParams.get('description') || 'Sample Description');
        const imageSrc = decodeURIComponent(urlParams.get('image') || 'default-image.jpg');

        document.getElementById('art-title').textContent = title;
        document.getElementById('art-artist').textContent = artist;
        document.getElementById('art-description').textContent = description;
        document.getElementById('art-image').src = imageSrc;
        document.getElementById('art-image').alt = title;

        const ratingStars = document.querySelectorAll('.rating-input i');
        ratingStars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = this.dataset.rating;
                document.getElementById('rating').value = rating;
                updateStars(rating);
            });

            star.addEventListener('mouseover', function() {
                const rating = this.dataset.rating;
                highlightStars(rating);
            });

            star.addEventListener('mouseout', function() {
                const currentRating = document.getElementById('rating').value;
                highlightStars(currentRating);
            });
        });

        function updateStars(rating) {
            ratingStars.forEach(star => {
                const starRating = star.dataset.rating;
                star.className = starRating <= rating ? 'fas fa-star' : 'far fa-star';
            });
        }

        function highlightStars(rating) {
            ratingStars.forEach(star => {
                const starRating = star.dataset.rating;
                star.className = starRating <= rating ? 'fas fa-star' : 'far fa-star';
            });
        }

        function loadComments() {
            const comments = JSON.parse(localStorage.getItem(title)) || [];
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';

            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="no-comments">Be the first to comment!</p>';
                return;
            }

            comments.forEach((comment, index) => {
                const commentElement = document.createElement('div');
                commentElement.classList.add('comment');
                commentElement.innerHTML = `
                    <div class="comment-header">
                        <div class="user-info">
                            <img src="${comment.userImage || 'default-avatar.jpg'}" alt="User" class="user-avatar">
                            <div class="comment-meta">
                                <span class="username">${comment.username || 'Anonymous'}</span>
                                <span class="timestamp">${formatTimestamp(comment.timestamp || Date.now())}</span>
                            </div>
                        </div>
                        <div class="rating-display">
                            ${generateStarRating(comment.rating)}
                        </div>
                    </div>
                    <div class="comment-content" id="content-${index}">${comment.thoughts}</div>
                    <div class="edit-form-${index}" style="display: none;">
                        <textarea class="form-control mb-2">${comment.thoughts}</textarea>
                        <div class="rating-input mb-2">
                            ${Array(5).fill(0).map((_, i) => `
                                <i class="${i < comment.rating ? 'fas' : 'far'} fa-star" data-rating="${i + 1}"></i>
                            `).join('')}
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" onclick="saveEdit(${index})">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelInlineEdit(${index})">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                    <div class="comment-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="editInlineComment(${index})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${index})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                commentsList.appendChild(commentElement);
            });

            updateAverageRating(comments);
        }

        function generateStarRating(rating) {
            return Array(5).fill(0).map((_, i) => 
                `<i class="${i < rating ? 'fas' : 'far'} fa-star"></i>`
            ).join('');
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updateAverageRating(comments) {
            if (comments.length === 0) return;

            const totalRating = comments.reduce((sum, comment) => sum + Number(comment.rating), 0);
            const averageRating = totalRating / comments.length;
            
            document.getElementById('average-rating').innerHTML = generateStarRating(Math.round(averageRating));
            document.getElementById('rating-count').textContent = `(${comments.length} ratings)`;
        }

        function handleSubmit(event) {
            event.preventDefault();

            const thoughts = document.getElementById("thoughts").value.trim();
            const rating = document.getElementById("rating").value;

            if (!rating) {
                showToast('Please select a rating', 'error');
                return;
            }

            let comments = JSON.parse(localStorage.getItem(title)) || [];

            const newComment = {
                thoughts,
                rating,
                timestamp: Date.now(),
                username: localStorage.getItem('username') || 'Anonymous',
                userImage: localStorage.getItem('userImage') || 'default-avatar.jpg'
            };

            comments.push(newComment);
            localStorage.setItem(title, JSON.stringify(comments));
            
            document.getElementById("discussion-form").reset();
            updateStars(0);
            loadComments();
            showToast('Comment added successfully!', 'success');
        }

        function editInlineComment(index) {
            const comment = document.querySelectorAll('.comment')[index];
            const contentDiv = comment.querySelector(`#content-${index}`);
            const editForm = comment.querySelector(`.edit-form-${index}`);
            
            contentDiv.style.display = 'none';
            editForm.style.display = 'block';
            comment.classList.add('editing');

            const stars = editForm.querySelectorAll('.rating-input i');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = this.dataset.rating;
                    updateInlineStars(stars, rating);
                });

                star.addEventListener('mouseover', function() {
                    const rating = this.dataset.rating;
                    highlightInlineStars(stars, rating);
                });

                star.addEventListener('mouseout', function() {
                    const currentRating = getCurrentRating(stars);
                    highlightInlineStars(stars, currentRating);
                });
            });
        }

        function saveEdit(index) {
            const comment = document.querySelectorAll('.comment')[index];
            const editForm = comment.querySelector(`.edit-form-${index}`);
            const newText = editForm.querySelector('textarea').value.trim();
            const newRating = getCurrentRating(editForm.querySelectorAll('.rating-input i'));

            const comments = JSON.parse(localStorage.getItem(title)) || [];
            comments[index] = {
                ...comments[index],
                thoughts: newText,
                rating: newRating
            };

            localStorage.setItem(title, JSON.stringify(comments));
            loadComments();
            showToast('Comment updated successfully!', 'success');
        }

        function cancelInlineEdit(index) {
            const comment = document.querySelectorAll('.comment')[index];
            const contentDiv = comment.querySelector(`#content-${index}`);
            const editForm = comment.querySelector(`.edit-form-${index}`);
            
            contentDiv.style.display = 'block';
            editForm.style.display = 'none';
            comment.classList.remove('editing');
        }

        function updateInlineStars(stars, rating) {
            stars.forEach(star => {
                const starRating = star.dataset.rating;
                star.className = starRating <= rating ? 'fas fa-star' : 'far fa-star';
            });
        }

        function highlightInlineStars(stars, rating) {
            stars.forEach(star => {
                const starRating = star.dataset.rating;
                star.className = starRating <= rating ? 'fas fa-star' : 'far fa-star';
            });
        }

        function getCurrentRating(stars) {
            let rating = 0;
            stars.forEach(star => {
                if (star.classList.contains('fas')) {
                    rating = Math.max(rating, parseInt(star.dataset.rating));
                }
            });
            return rating;
        }

        function deleteComment(index) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            document.body.appendChild(overlay);

            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'delete-confirm';
            confirmDialog.innerHTML = `
                <h4>Delete Comment</h4>
                <p>Are you sure you want to delete this comment?</p>
                <div class="buttons">
                    <button class="btn btn-outline-secondary" onclick="cancelDelete()">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDelete(${index})">Delete</button>
                </div>
            `;
            document.body.appendChild(confirmDialog);
        }

        function cancelDelete() {
            removeDeleteDialog();
        }

        function confirmDelete(index) {
            const comments = JSON.parse(localStorage.getItem(title)) || [];
            comments.splice(index, 1);
            localStorage.setItem(title, JSON.stringify(comments));
            
            removeDeleteDialog();
            loadComments();
            showToast('Comment deleted successfully', 'success');
        }

        function removeDeleteDialog() {
            const overlay = document.querySelector('.overlay');
            const confirmDialog = document.querySelector('.delete-confirm');
            
            if (overlay) overlay.remove();
            if (confirmDialog) confirmDialog.remove();
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast-notification ${type}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        loadComments();
    </script>
</body>
</html>